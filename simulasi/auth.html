<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab A07: Auth Failures</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.addEventListener('contextmenu', e => e.preventDefault());
            document.onkeydown = e => { if(e.keyCode == 123 || (e.ctrlKey && e.keyCode == 85)) return false; };
        });
    </script>

    <style>
        /* BASE STYLES */
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; height: 100vh; overflow: hidden; color: #e2e8f0; }
        .lab-wrapper { display: flex; height: 100vh; }
        
        /* SIDEBAR */
        .sidebar { width: 400px; background: #1e293b; border-right: 1px solid #334155; display: flex; flex-direction: column; z-index: 10; box-shadow: 5px 0 15px rgba(0,0,0,0.3); }
        .sidebar-header { padding: 20px; background: #020617; border-bottom: 1px solid #334155; }
        .sidebar-content { flex-grow: 1; padding: 20px; overflow-y: auto; }
        
        .level-badge { font-size: 0.75rem; text-transform: uppercase; background: #be123c; border: 1px solid #f43f5e; color: #ffe4e6; padding: 5px 10px; border-radius: 4px; margin-bottom: 10px; display: inline-block; }
        .mission-card { background: #334155; border-radius: 8px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #f43f5e; animation: fadeIn 0.5s; }
        .hint-box { background: #451a03; border: 1px solid #f59e0b; color: #fcd34d; padding: 15px; border-radius: 8px; margin-top: 10px; display: none; font-size: 0.9rem; border-left: 4px solid #f59e0b; }
        
        /* CODE REMEDIATION STYLES */
        .code-display { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; background: #000; padding: 15px; border-radius: 6px; border: 1px solid #334155; margin-top: 10px; color: #a5b4fc; display: none; }
        .code-display.active { display: block; }
        .code-comment { color: #6b7280; font-style: italic; }
        .code-bad { color: #f87171; }
        .code-good { color: #4ade80; }

        /* MAIN AREA */
        .main-area { flex-grow: 1; padding: 30px; background: #0f172a; display: flex; flex-direction: column; gap: 20px; }

        /* TARGET BROWSER */
        .browser { background: #fff; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; height: 50%; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #475569; position: relative; }
        .browser-bar { background: #f1f5f9; padding: 8px 15px; border-bottom: 1px solid #cbd5e1; display: flex; align-items: center; }
        .url-box { background: #fff; border: 1px solid #cbd5e1; border-radius: 20px; padding: 4px 15px; flex-grow: 1; margin-left: 15px; font-size: 0.85rem; color: #64748b; font-family: monospace; }
        .app-view { flex-grow: 1; background: #f8fafc; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        .login-box { width: 320px; padding: 30px; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .response-msg { font-size: 0.8rem; margin-top: 10px; text-align: center; display: none; }

        /* ATTACK TOOL */
        .attack-tool { flex: 1; background: #020617; border: 1px solid #1e293b; border-radius: 8px; display: flex; flex-direction: column; font-family: 'JetBrains Mono', monospace; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); opacity: 0.6; pointer-events: none; transition: all 0.3s; }
        .attack-tool.active { opacity: 1; pointer-events: auto; border-color: #f43f5e; }
        .tool-header { background: #1e293b; padding: 10px; color: #f43f5e; font-size: 0.8rem; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; }
        .tool-body { padding: 20px; display: flex; gap: 20px; height: 100%; }
        
        .config-panel { width: 40%; border-right: 1px solid #334155; padding-right: 20px; display: flex; flex-direction: column; gap: 15px; }
        .log-panel { width: 60%; background: #000; border-radius: 5px; padding: 10px; overflow-y: auto; font-size: 0.8rem; color: #22c55e; max-height: 200px; }
        
        .tool-input { background: #0f172a; border: 1px solid #334155; color: white; padding: 5px; width: 100%; font-size: 0.8rem; }
        .wordlist-select { background: #0f172a; border: 1px solid #334155; color: white; padding: 5px; width: 100%; font-size: 0.8rem; height: 35px; }
        
        /* Button States */
        #btnAttack:disabled { background: #334155; border-color: #475569; color: #94a3b8; cursor: not-allowed; }
        #btnAttack:enabled { background: #dc2626; border-color: #ef4444; color: white; cursor: pointer; animation: pulse 2s infinite; }
        
        .status-success { color: #22c55e; font-weight: bold; }
        .status-fail { color: #ef4444; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="lab-wrapper">
    <div class="sidebar">
        <div class="sidebar-header">
            <h5 class="mb-0 fw-bold text-danger"><i class="fas fa-user-lock me-2"></i>Auth Failures</h5>
            <small class="text-secondary">Level: <span id="levelIndicator">1/6</span></small>
        </div>
        <div class="sidebar-content">
            <div id="missionDisplay"></div>
            
            <div class="mt-4 pt-3 border-top border-secondary">
                <button onclick="toggleHint()" class="btn btn-outline-warning btn-sm w-100 mb-2">
                    <i class="far fa-lightbulb me-2"></i>Bantuan / Hint
                </button>
                <div id="hintBox" class="hint-box"></div>
            </div>

            <div id="remediationSection" style="display: none;">
                <hr class="border-secondary my-4">
                <h6 class="text-success fw-bold"><i class="fas fa-code-branch me-2"></i>Analisis Kerentanan</h6>
                <p class="small text-secondary mb-3">Sistem ini jebol karena 3 kesalahan fatal. Pelajari cara memperbaikinya:</p>
                
                <div class="d-flex gap-2 mb-2">
                    <button class="btn btn-xs btn-outline-danger w-50 active" onclick="showCode('vuln')">Kode Rentan</button>
                    <button class="btn btn-xs btn-outline-success w-50" onclick="showCode('secure')">Kode Aman</button>
                </div>

                <div id="codeVuln" class="code-display active">
<span class="code-comment">// 1. ENUMERASI USERNAME</span>
if (!$user) {
    <span class="code-bad">die("User tidak ditemukan");</span> <span class="code-comment">// Info bocor!</span>
}

<span class="code-comment">// 2. NO RATE LIMITING</span>
if ($pass !== $db_pass) {
    <span class="code-bad">// Tidak ada counter gagal</span>
    die("Password salah");
}

<span class="code-comment">// 3. WEAK MFA (PIN)</span>
if ($input_pin !== "1234") {
    die("PIN Salah"); 
    <span class="code-comment">// PIN 4 digit mudah di-bruteforce</span>
}
                </div>

                <div id="codeSecure" class="code-display">
<span class="code-comment">// 1. GENERIC ERROR</span>
if (!$user || !$pass_match) {
    <span class="code-good">die("Username atau Password Salah");</span>
}

<span class="code-comment">// 2. RATE LIMITING (Throttling)</span>
if ($failed_attempts > 5) {
    <span class="code-good">die("Akun dikunci selama 15 menit");</span>
}

<span class="code-comment">// 3. STRONG MFA (TOTP)</span>
// Gunakan Google Authenticator
if (!verifyTOTP($user_secret, $input_code)) {
    die("Kode 2FA Invalid");
}
                </div>

                <button onclick="finishLab()" class="btn btn-success w-100 mt-4 fw-bold">Selesai & Keluar</button>
            </div>
        </div>
        
        <div class="p-3 bg-black text-center border-top border-secondary">
            <a href="../index.html" class="text-white-50 text-decoration-none small">Dashboard</a>
        </div>
    </div>

    <div class="main-area">
        
        <div class="browser">
            <div class="browser-bar">
                <div class="d-flex gap-1 me-2"><span class="rounded-circle bg-danger" style="width:10px;height:10px"></span><span class="rounded-circle bg-warning" style="width:10px;height:10px"></span></div>
                <div class="url-box" id="urlDisplay">admin.portal.local/login</div>
            </div>
            <div class="app-view">
                <div id="pageLogin" class="login-box">
                    <div class="text-center mb-3"><i class="fas fa-shield-alt fa-3x text-primary"></i><h5 class="fw-bold mt-2">Admin Portal</h5></div>
                    <div class="mb-2"><label class="small fw-bold">Username</label><input type="text" id="targetUser" class="form-control form-control-sm" placeholder="admin"></div>
                    <div class="mb-3"><label class="small fw-bold">Password</label><input type="password" id="targetPass" class="form-control form-control-sm"></div>
                    <button onclick="manualLogin()" class="btn btn-primary w-100 btn-sm fw-bold">Login</button>
                    <div class="text-center mt-2"><a href="#" onclick="showPage('pageForgot')" class="small">Lupa Password?</a></div>
                    <div id="loginMsg" class="response-msg text-danger"></div>
                </div>
                <div id="pageForgot" class="login-box" style="display:none;">
                    <div class="text-center mb-3"><h6 class="fw-bold">Recovery Akun</h6><p class="small text-muted">Cek ketersediaan username.</p></div>
                    <input type="text" id="checkUser" class="form-control form-control-sm mb-3" placeholder="Username...">
                    <button onclick="checkUsername()" class="btn btn-secondary w-100 btn-sm">Cek User</button>
                    <div id="forgotMsg" class="response-msg"></div>
                    <div class="text-center mt-2"><a href="#" onclick="showPage('pageLogin')" class="small">Kembali</a></div>
                </div>
                <div id="pagePin" class="login-box" style="display:none;">
                    <div class="text-center mb-3"><i class="fas fa-lock fa-2x text-warning"></i><h6 class="fw-bold mt-2">Security PIN</h6><p class="small text-muted">Masukkan 4 digit PIN.</p></div>
                    <input type="text" id="pinInput" class="form-control text-center letter-spacing-2 mb-3" maxlength="4" placeholder="----">
                    <button onclick="checkPin()" class="btn btn-warning w-100 btn-sm fw-bold">Verifikasi</button>
                    <div id="pinMsg" class="response-msg text-danger"></div>
                </div>
                <div id="pageSuccess" class="text-center p-5" style="display:none;"><i class="fas fa-unlock-alt fa-4x text-success mb-3"></i><h2 class="fw-bold">ACCESS GRANTED</h2><p>Selamat! Anda telah menguasai sistem.</p></div>
            </div>
        </div>

        <div id="attackTool" class="attack-tool">
            <div class="tool-header"><span><i class="fas fa-terminal me-2"></i>BRUTE FORCE CONSOLE</span><span id="toolStatus" class="badge bg-secondary">LOCKED</span></div>
            <div class="tool-body">
                <div class="config-panel">
                    <label class="small text-secondary fw-bold">Target User:</label>
                    <input type="text" id="toolTarget" class="tool-input mb-2" placeholder="e.g. admin" disabled>
                    <label class="small text-secondary fw-bold">Mode:</label>
                    <select id="toolMode" class="wordlist-select mb-2" onchange="updateToolUI()" disabled><option value="pass">Password Attack</option><option value="pin">PIN Cracking</option></select>
                    <label class="small text-secondary fw-bold">Wordlist:</label>
                    <select id="toolWordlist" class="wordlist-select mb-3" disabled><option value="">-- Select --</option><option value="rockyou">rockyou.txt (Top 1000)</option><option value="pins">4-digit-pins.txt</option></select>
                    
                    <div id="configStatus" class="small text-danger mb-2" style="height: 20px;"></div>
                    <button id="btnAttack" onclick="startAttack()" class="btn btn-danger btn-sm w-100 fw-bold" disabled>START ATTACK</button>
                </div>
                <div class="log-panel" id="attackLog"><span class="text-secondary">> Tool locked. Complete Level 2 to unlock...</span></div>
            </div>
        </div>
    </div>
</div>

<script>
    const targetUser = "administrator";
    const targetPass = "dragon";
    const targetPin = "1337";
    let level = 1;

    const missions = [
        {},
        { badge: "Tahap 1: Enumerasi", title: "Mencari Username", desc: "Gunakan fitur 'Lupa Password' untuk mencari username yang valid.<br><br>1. Masuk menu Lupa Password.<br>2. Cek: <code>admin</code> (Invalid).<br>3. Cek: <code>administrator</code> (Valid).", hint: "Respon 'Link reset terkirim' artinya username valid." },
        { badge: "Tahap 2: Manual Testing", title: "Cek Password Default", desc: "Username: <strong>administrator</strong>.<br>Kembali ke Login. Coba login manual dengan password asal.<br><br>Ini wajib dilakukan agar kita tahu pesan errornya sebelum memakai alat.", hint: "Login manual harus gagal dulu untuk membuka alat Attack." },
        { badge: "Tahap 3: Konfigurasi Alat", title: "Setup Brute Force", desc: "Login gagal. Alat di bawah sekarang <strong>TERBUKA</strong>.<br><br>1. Target User: <code>administrator</code><br>2. Wordlist: <strong>rockyou.txt</strong><br>3. Klik START.", hint: "Pastikan ejaan 'administrator' benar." },
        { badge: "Tahap 4: Password Cracking", title: "Jalankan Serangan", desc: "Tunggu hingga alat menemukan password.", hint: "Password yang ditemukan akan berwarna hijau." },
        { badge: "Tahap 5: 2FA Bypass", title: "PIN Cracking", desc: "Password: <strong>dragon</strong>. Login manual sekarang.<br><br>Ups! Ada PIN. Kembali ke Tool:<br>1. Ubah Mode ke <strong>PIN Cracking</strong>.<br>2. Start Attack lagi.", hint: "Login browser dulu sampai halaman PIN muncul." },
        { badge: "Tahap 6: Full Access", title: "Login Final", desc: "PIN: <strong>1337</strong>. Masukkan PIN untuk akses penuh.", hint: "Masukkan 1337." },
        { badge: "Mission Complete", title: "Sistem Dikuasai", desc: "Anda berhasil masuk.", hint: "Selesai." }
    ];

    function renderMission() {
        if(level > 6) return;
        const m = missions[level];
        document.getElementById('levelIndicator').innerText = level + "/6";
        document.getElementById('missionDisplay').innerHTML = `<span class="level-badge">${m.badge}</span><div class="mission-card"><h5 class="fw-bold mb-3 text-white">${m.title}</h5><p class="small text-light opacity-75">${m.desc}</p></div>`;
        document.getElementById('hintBox').style.display = 'none';
        document.getElementById('hintBox').innerHTML = `<i class="fas fa-info-circle me-2"></i>${m.hint}`;
        
        if(level >= 3) {
            const tool = document.getElementById('attackTool');
            tool.classList.add('active');
            document.getElementById('toolStatus').className = "badge bg-success";
            document.getElementById('toolStatus').innerText = "ONLINE";
            document.getElementById('toolTarget').disabled = false;
            document.getElementById('toolMode').disabled = false;
            document.getElementById('toolWordlist').disabled = false;
            // Hanya reset log jika belum ada proses
            if(document.getElementById('attackLog').innerText.includes("locked")) {
                document.getElementById('attackLog').innerHTML = "<span class='text-success'>> System Ready. Configure target...</span>";
            }
        }
    }

    function toggleHint() { const box = document.getElementById('hintBox'); box.style.display = box.style.display === 'block' ? 'none' : 'block'; }
    function showPage(pageId) {
        ['pageLogin', 'pageForgot', 'pagePin', 'pageSuccess'].forEach(p => document.getElementById(p).style.display = 'none');
        document.getElementById(pageId).style.display = 'block';
        document.querySelectorAll('.response-msg').forEach(el => el.style.display = 'none');
    }

    function checkUsername() {
        const u = document.getElementById('checkUser').value.toLowerCase().trim();
        const msg = document.getElementById('forgotMsg');
        msg.style.display = 'block';
        if(u === targetUser) {
            msg.className = "response-msg text-success fw-bold";
            msg.innerHTML = "Link reset terkirim!";
            if(level === 1) { setTimeout(() => { alert("Username Valid! Lanjut Tahap 2."); level = 2; renderMission(); showPage('pageLogin'); }, 1000); }
        } else {
            msg.className = "response-msg text-danger";
            msg.innerHTML = "User tidak ditemukan.";
        }
    }

    function manualLogin() {
        const u = document.getElementById('targetUser').value.trim();
        const p = document.getElementById('targetPass').value;
        const msg = document.getElementById('loginMsg');
        msg.style.display = 'block';

        if(u === targetUser && p === targetPass) {
            showPage('pagePin');
            if(level === 4) { level = 5; renderMission(); alert("Berhasil login! Tapi ada PIN. Kembali ke Alat Attack."); }
        } else {
            msg.innerHTML = "Login Gagal.";
            if(level === 2) { 
                setTimeout(() => { alert("Login Manual Gagal. Alat Brute Force Terbuka."); level = 3; renderMission(); }, 500);
            }
        }
    }

    function checkPin() {
        if(document.getElementById('pinInput').value === targetPin) {
            showPage('pageSuccess');
            if(level === 6) { level = 7; renderMission(); document.getElementById('remediationSection').style.display = 'block'; }
        } else {
            document.getElementById('pinMsg').style.display = 'block';
            document.getElementById('pinMsg').innerText = "PIN Salah.";
        }
    }

    // --- TOOL LOGIC & VALIDATION ---
    document.getElementById('toolTarget').addEventListener('keyup', checkConfig);
    document.getElementById('toolWordlist').addEventListener('change', checkConfig);

    function updateToolUI() {
        const mode = document.getElementById('toolMode').value;
        const wl = document.getElementById('toolWordlist');
        if(mode === 'pass') wl.value = 'rockyou'; else wl.value = 'pins';
        checkConfig();
    }

    function checkConfig() {
        const t = document.getElementById('toolTarget').value.trim().toLowerCase();
        const w = document.getElementById('toolWordlist').value;
        const btn = document.getElementById('btnAttack');
        const status = document.getElementById('configStatus');

        if(t === targetUser && w !== "") {
            btn.disabled = false;
            status.innerHTML = "";
        } else {
            btn.disabled = true;
            if(t !== "" && t !== targetUser) status.innerHTML = "Error: Target User mismatch!";
            else if(w === "") status.innerHTML = "Error: Select Wordlist!";
            else status.innerHTML = "";
        }
    }

    function startAttack() {
        const mode = document.getElementById('toolMode').value;
        const log = document.getElementById('attackLog');
        const btn = document.getElementById('btnAttack');
        
        btn.disabled = true;
        log.innerHTML = "";
        
        let attempts = mode === 'pass' ? ["123456", "password", "admin123", "dragon"] : ["0000", "1234", "1111", "1337"];
        let success = mode === 'pass' ? targetPass : targetPin;
        let i = 0;

        const interval = setInterval(() => {
            const current = attempts[i];
            if(current === success) {
                clearInterval(interval);
                log.innerHTML += `<div class='status-success'>[FOUND] ${current}</div>`;
                log.scrollTop = log.scrollHeight;
                if(level === 3 && mode === 'pass') { level = 4; renderMission(); alert("Password: dragon. Login manual sekarang."); }
                if(level === 5 && mode === 'pin') { level = 6; renderMission(); alert("PIN: 1337. Masukkan PIN sekarang."); }
                btn.disabled = false;
            } else {
                log.innerHTML += `<div class='status-fail'>[TRY] ${current}</div>`;
                log.scrollTop = log.scrollHeight;
            }
            i++;
        }, 500);
    }

    function showCode(type) {
        document.getElementById('codeVuln').classList.remove('active');
        document.getElementById('codeSecure').classList.remove('active');
        if(type === 'vuln') document.getElementById('codeVuln').classList.add('active');
        else document.getElementById('codeSecure').classList.add('active');
    }

    function finishLab() { localStorage.setItem('sim_a07', 'done'); window.location.href = '../index.html'; }
    
    renderMission();
</script>
</body>
</html>
