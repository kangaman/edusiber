<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab A08: Integrity Failures</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.addEventListener('contextmenu', e => e.preventDefault());
            document.onkeydown = e => { if(e.keyCode == 123 || (e.ctrlKey && e.keyCode == 85)) return false; };
        });
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; height: 100vh; overflow: hidden; color: #e2e8f0; }
        .lab-wrapper { display: flex; height: 100vh; }
        
        /* SIDEBAR */
        .sidebar { width: 400px; background: #1e293b; border-right: 1px solid #334155; display: flex; flex-direction: column; z-index: 10; box-shadow: 5px 0 15px rgba(0,0,0,0.3); }
        .sidebar-header { padding: 20px; background: #020617; border-bottom: 1px solid #334155; }
        .sidebar-content { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .level-badge { font-size: 0.75rem; text-transform: uppercase; background: #6d28d9; border: 1px solid #8b5cf6; color: #ede9fe; padding: 5px 10px; border-radius: 4px; margin-bottom: 10px; display: inline-block; }
        .mission-card { background: #334155; border-radius: 8px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #8b5cf6; animation: fadeIn 0.5s; }
        .hint-box { background: #451a03; border: 1px solid #f59e0b; color: #fcd34d; padding: 15px; border-radius: 8px; margin-top: 10px; display: none; font-size: 0.9rem; border-left: 4px solid #f59e0b; }
        .code-snippet { font-family: 'Fira Code', monospace; font-size: 0.8rem; background: #000; padding: 15px; border-radius: 6px; border: 1px solid #334155; margin-top: 10px; display: none; color: #a5b4fc; }

        /* MAIN AREA */
        .main-area { flex-grow: 1; padding: 30px; background: #0f172a; display: flex; flex-direction: column; gap: 20px; }

        /* BROWSER */
        .browser { background: #fff; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; height: 50%; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #475569; position: relative; }
        .browser-bar { background: #f1f5f9; padding: 8px 15px; border-bottom: 1px solid #cbd5e1; display: flex; align-items: center; }
        .url-box { background: #fff; border: 1px solid #cbd5e1; border-radius: 20px; padding: 4px 15px; flex-grow: 1; margin-left: 15px; font-size: 0.85rem; color: #64748b; font-family: monospace; }
        .app-view { flex-grow: 1; background: #f8fafc; padding: 20px; overflow-y: auto; position: relative; }

        /* TOOLS CONTAINER */
        .tools-container { display: flex; gap: 20px; height: 45%; }
        
        /* EDITOR TOOL */
        .editor-tool { flex: 1; background: #020617; border: 1px solid #1e293b; border-radius: 8px; display: flex; flex-direction: column; font-family: 'Fira Code', monospace; }
        .tool-header { background: #1e293b; padding: 10px; color: #a5b4fc; font-size: 0.8rem; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; }
        .tool-body { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; gap: 10px; }
        
        .cookie-display { background: #0f172a; border: 1px solid #334155; color: #e2e8f0; padding: 10px; font-size: 0.85rem; height: 60px; word-break: break-all; resize: none; width: 100%; }
        .decoded-display { background: #000; border: 1px solid #334155; color: #4ade80; padding: 10px; flex-grow: 1; font-size: 0.85rem; white-space: pre-wrap; font-family: 'Fira Code', monospace; resize: none; width: 100%; }
        
        /* SOURCE VIEWER */
        .source-tool { flex: 1; background: #1e1e1e; border: 1px solid #334155; border-radius: 8px; display: flex; flex-direction: column; opacity: 0.5; pointer-events: none; transition: all 0.3s; }
        .source-tool.active { opacity: 1; pointer-events: auto; border-color: #8b5cf6; }
        .source-code { padding: 15px; color: #d4d4d4; font-family: 'Fira Code', monospace; font-size: 0.8rem; overflow-y: auto; flex-grow: 1; white-space: pre; }

        /* UI Elements */
        .user-panel { border: 1px solid #e2e8f0; background: white; border-radius: 8px; padding: 20px; max-width: 600px; margin: 20px auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .role-badge { background: #64748b; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; text-transform: uppercase; }
        .role-badge.admin { background: #dc2626; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="lab-wrapper">
    <div class="sidebar">
        <div class="sidebar-header">
            <h5 class="mb-0 fw-bold" style="color: #a78bfa;"><i class="fas fa-fingerprint me-2"></i>Integrity Failures</h5>
            <small class="text-secondary">Level: <span id="levelIndicator">1/5</span></small>
        </div>
        <div class="sidebar-content">
            <div id="missionDisplay"></div>
            
            <div class="mt-4 pt-3 border-top border-secondary">
                <button onclick="toggleHint()" class="btn btn-outline-warning btn-sm w-100 mb-2">
                    <i class="far fa-lightbulb me-2"></i>Hint / Jawaban
                </button>
                <div id="hintBox" class="hint-box"></div>
            </div>

            <div id="remediationSection" style="display: none;">
                <hr class="border-secondary my-4">
                <h6 class="text-success fw-bold">Analisis Kode</h6>
                <div class="d-flex gap-2 mb-2">
                    <button class="btn btn-xs btn-outline-danger w-50 active" onclick="showCode('vuln')">Vulnerable</button>
                    <button class="btn btn-xs btn-outline-success w-50" onclick="showCode('secure')">Secure</button>
                </div>
                <div id="codeVuln" class="code-snippet">
// ❌ RENTAN: Unserialize Input User
$data = $_COOKIE['session'];
$obj = unserialize(base64_decode($data));
// Objek langsung dibuat tanpa validasi
                </div>
                <div id="codeSecure" class="code-snippet">
// ✅ AMAN: Integrity Check (HMAC)
$data = $_COOKIE['session'];
$sig = $_COOKIE['sig'];

if (!hash_equals(hmac($data), $sig)) {
    die("Tampered!");
}
$obj = json_decode($data);
                </div>
                <button onclick="finishLab()" class="btn btn-success w-100 mt-3 fw-bold">Selesai</button>
            </div>
        </div>
        <div class="p-3 bg-black text-center border-top border-secondary">
            <a href="../index.html" class="text-white-50 text-decoration-none small">Dashboard</a>
        </div>
    </div>

    <div class="main-area">
        
        <div class="browser">
            <div class="browser-bar">
                <div class="d-flex gap-1 me-2"><span class="rounded-circle bg-danger" style="width:10px;height:10px"></span><span class="rounded-circle bg-warning" style="width:10px;height:10px"></span></div>
                <div class="url-box">internal-dashboard.local</div>
                <button onclick="renderApp()" class="btn btn-sm btn-light border ms-2"><i class="fas fa-redo"></i></button>
            </div>
            <div class="app-view" id="appView">
                </div>
        </div>

        <div class="tools-container">
            <div class="editor-tool">
                <div class="tool-header"><span>COOKIE TAMPERING TOOL</span><span class="badge bg-primary">ACTIVE</span></div>
                <div class="tool-body">
                    <label class="small text-secondary">1. Raw Cookie (Base64):</label>
                    <textarea id="rawCookie" class="cookie-display" disabled></textarea>
                    
                    <div class="d-flex gap-2">
                        <button onclick="decodeCookie()" class="btn btn-outline-info btn-sm w-50">Decode <i class="fas fa-arrow-down"></i></button>
                        <button onclick="encodeCookie()" class="btn btn-outline-warning btn-sm w-50" id="btnEncode" disabled>Encode <i class="fas fa-arrow-up"></i></button>
                    </div>

                    <label class="small text-secondary">2. Decoded Object (PHP Serialized):</label>
                    <textarea id="decodedCookie" class="decoded-display" placeholder="Click Decode first..." disabled onkeyup="checkEdit()"></textarea>
                    
                    <button onclick="injectCookie()" class="btn btn-danger btn-sm w-100 fw-bold" id="btnInject" disabled>INJECT & REFRESH</button>
                </div>
            </div>

            <div id="sourceTool" class="source-tool">
                <div class="tool-header"><span>SOURCE CODE</span><span class="badge bg-secondary">LEAKED</span></div>
                <div class="source-code" id="sourceCodeContent">
// User.php
class User {
    public $username;
    public $role = "guest";
}

// Logger.php (VULNERABLE)
class FileLogger {
    public $logFile;
    public $content;

    // Dipanggil saat objek dihancurkan
    public function __destruct() {
        // MENULIS FILE KE SERVER!
        file_put_contents($this->logFile, $this->content);
    }
}
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // --- STATE ---
    let level = 1;
    let currentUser = { role: "guest", username: "budi_staff" };
    
    // Initial Serialized String (guest)
    let currentSerialized = `O:4:"User":2:{s:8:"username";s:10:"budi_staff";s:4:"role";s:5:"guest";}`;

    const missions = [
        {},
        {
            badge: "Tahap 1: Reconnaissance",
            title: "Analisis Cookie",
            desc: "Aplikasi menggunakan Cookie untuk menyimpan data sesi.<br><br>Lihat kotak <strong>Cookie Tool</strong> di kiri bawah. Teks acak itu adalah Base64.<br><br><strong>Tugas:</strong> Klik tombol <strong>Decode</strong> untuk menerjemahkannya.",
            hint: "Klik tombol Decode berwarna biru."
        },
        {
            badge: "Tahap 2: Privilege Escalation",
            title: "Manipulasi Objek",
            desc: "Decoding berhasil! Anda melihat struktur data PHP: <code>s:4:\"role\";s:5:\"guest\"</code>.<br><br>Server mempercayai data ini tanpa verifikasi.<br><strong>Tugas:</strong><br>1. Ubah tulisan <code>guest</code> menjadi <code>admin</code> di kotak editor.<br>2. Klik <strong>Encode</strong>.<br>3. Klik <strong>INJECT</strong>.",
            hint: "Ubah menjadi: <code>...s:4:\"role\";s:5:\"admin\";...</code><br>Pastikan Anda mengklik Encode lalu Inject."
        },
        {
            badge: "Tahap 3: Source Code Review",
            title: "Mencari Celah RCE",
            desc: "Selamat, Anda Admin! Panel Source Code di kanan sekarang terbuka.<br><br>Baca kodenya. Ada kelas <code>FileLogger</code> dengan fungsi <code>__destruct</code> yang berbahaya karena bisa menulis file.<br><br>Kita bisa membuat objek palsu dari kelas ini.",
            hint: "Kita akan menyuntikkan objek FileLogger untuk membuat file shell."
        },
        {
            badge: "Tahap 4: Object Injection",
            title: "Remote Code Execution",
            desc: "Mari kita buat *backdoor*.<br><br>Hapus semua teks di kotak editor, lalu masukkan Payload ini:<br><code>O:10:\"FileLogger\":2:{s:7:\"logFile\";s:9:\"shell.php\";s:7:\"content\";s:18:\"&lt;?php system('id');\";}</code><br><br>Lalu Encode & Inject.",
            hint: "Copy payload di atas, Paste di editor, Encode, Inject."
        },
        {
            badge: "Mission Complete",
            title: "System Compromised",
            desc: "<strong>SUKSES!</strong><br>Server menerima objek berbahaya tersebut dan menjalankannya. File <code>shell.php</code> berhasil dibuat di server.",
            hint: "Selesai."
        }
    ];

    function renderMission() {
        if(level > 5) return;
        const m = missions[level];
        document.getElementById('levelIndicator').innerText = level + "/5";
        document.getElementById('missionDisplay').innerHTML = `<span class="level-badge">${m.badge}</span><div class="mission-card"><h5 class="fw-bold mb-3 text-white">${m.title}</h5><p class="small text-light opacity-75">${m.desc}</p></div>`;
        document.getElementById('hintBox').style.display = 'none';
        document.getElementById('hintBox').innerHTML = `<i class="fas fa-info-circle me-2"></i>${m.hint}`;
        
        // UNLOCK LOGIC (FIXED)
        if(level >= 3) {
            document.getElementById('sourceTool').classList.add('active');
        }
        
        renderApp();
    }

    function toggleHint() { const box = document.getElementById('hintBox'); box.style.display = box.style.display === 'block' ? 'none' : 'block'; }

    // --- APP RENDERER ---
    function renderApp() {
        const view = document.getElementById('appView');
        // Update Raw Cookie display from State
        document.getElementById('rawCookie').value = btoa(currentSerialized);

        if(currentUser.role === 'guest') {
            view.innerHTML = `
                <div class="text-center mt-5">
                    <h3>Internal Dashboard</h3>
                    <div class="user-panel">
                        <i class="fas fa-user-circle fa-3x text-secondary mb-3"></i><br>
                        <strong>${currentUser.username}</strong><br>
                        <span class="role-badge">Guest</span>
                        <div class="alert alert-secondary mt-3 text-start small">
                            <i class="fas fa-lock me-1"></i> Admin panel is restricted.
                        </div>
                    </div>
                </div>`;
        } else if (currentUser.role === 'admin') {
            view.innerHTML = `
                <div class="text-center mt-5">
                    <h3 class="text-danger">ADMIN DASHBOARD</h3>
                    <div class="user-panel border-danger">
                        <i class="fas fa-user-secret fa-3x text-danger mb-3"></i><br>
                        <strong>${currentUser.username}</strong><br>
                        <span class="role-badge admin">Administrator</span>
                        <div class="alert alert-success mt-3 text-start small">
                            <i class="fas fa-unlock me-1"></i> Access Granted.<br>
                            Debug Source Code: <strong>ENABLED</strong>
                        </div>
                    </div>
                </div>`;
        }
    }

    // --- TOOL LOGIC ---
    function decodeCookie() {
        const raw = document.getElementById('rawCookie').value;
        try {
            const decoded = atob(raw);
            const decodedArea = document.getElementById('decodedCookie');
            
            decodedArea.value = decoded;
            decodedArea.disabled = false; // UNLOCK EDITING
            
            // Auto advance level 1 -> 2
            if(level === 1) { 
                level = 2; 
                renderMission(); 
            }
        } catch(e) { alert("Invalid Base64"); }
    }

    function checkEdit() {
        // Enable Encode button only if text is changed
        document.getElementById('btnEncode').disabled = false;
    }

    function encodeCookie() {
        const text = document.getElementById('decodedCookie').value;
        // Update Raw Display
        document.getElementById('rawCookie').value = btoa(text);
        document.getElementById('btnInject').disabled = false;
    }

    function injectCookie() {
        const payload = document.getElementById('decodedCookie').value;
        currentSerialized = payload; // Update state
        
        // SIMULASI BACKEND LOGIC
        
        // 1. Cek Privilege Escalation (Guest -> Admin)
        if(payload.includes('s:5:"admin"')) {
            currentUser.role = 'admin';
            if(level === 2) { 
                alert("Inject Success! Welcome Admin.");
                level = 3; renderMission(); 
            }
        } else {
            currentUser.role = 'guest'; // Revert if wrong
        }

        // 2. Cek RCE (FileLogger Gadget)
        // Check keywords: FileLogger + shell.php
        if(payload.includes('FileLogger') && payload.includes('shell.php')) {
            if(level >= 3) {
                alert("RCE EXECUTED! File 'shell.php' created.");
                level = 5; // Finish
                renderMission();
                document.getElementById('remediationSection').style.display = 'block';
                document.querySelector('.sidebar-content').scrollTop = document.querySelector('.sidebar-content').scrollHeight;
            }
        }

        renderApp(); // Refresh View
    }

    function showCode(t) {
        document.getElementById('codeVuln').style.display = 'none';
        document.getElementById('codeSecure').style.display = 'none';
        document.getElementById(t==='vuln'?'codeVuln':'codeSecure').style.display = 'block';
    }
    
    function finishLab() { localStorage.setItem('sim_a08', 'done'); window.location.href = '../index.html'; }

    // Init
    renderMission();
    renderApp();
</script>
</body>
</html>
